# nixpacks.toml â€” put in repo root (lindsay/)

[phases.setup]
nixPkgs = ["python311", "nodejs-18_x"]

[phases.install]
cmds = [
  "cd backend && pip install --upgrade pip && pip install -r requirements.txt",
  "cd frontend && npm ci"   # faster and more reliable than npm install
]

[phases.build]
cmds = [
  # Build React/Vite frontend
  "cd frontend && npm run build || (echo 'Vite build failed!' && exit 1)",

  # Create the target folder if missing
  "mkdir -p backend/backend/static/vite",

  # Copy entire Vite dist/ into backend/backend/static/vite/
  "cp -r frontend/dist/* backend/backend/static/vite/ || (echo 'Copy failed - check frontend/dist exists' && exit 1)",

  # Run collectstatic (Whitenoise will serve from STATIC_ROOT)
  "cd backend && python manage.py collectstatic --noinput --clear || (echo 'collectstatic failed!' && exit 1)"
]

[start]
cmd = "cd backend && gunicorn backend.wsgi:application --bind 0.0.0.0:$PORT --workers 4 --timeout 120 --log-level info --access-logfile - --error-logfile -"